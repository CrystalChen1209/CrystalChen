<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´è´§é‡‡è´­ä¼˜åŒ– Â· å¤šé€‰ç»„åˆç‰ˆ</title>
    <style>
        * { box-sizing: border-box; font-family: 'Microsoft YaHei', sans-serif; }
        body { background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 25px; }
        h1 { color: #c41e3a; text-align: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        h2 { font-size: 1.3rem; color: #333; border-left: 6px solid #c41e3a; padding-left: 12px; margin: 25px 0 10px; }
        .settings-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .settings-item { display: flex; align-items: center; gap: 8px; }
        .settings-item label { font-weight: 600; color: #444; min-width: 70px; }
        .settings-item input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 150px; }
        .model-section { background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .model-group { margin-bottom: 20px; }
        .group-title { font-weight: 600; margin-bottom: 10px; color: #555; }
        .option-row { display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap; }
        .option-item { display: flex; flex-direction: column; background: #fff; padding: 12px 18px; border-radius: 8px; border: 1px solid #e0e0e0; min-width: 220px; }
        .option-item input[type="radio"], .option-item input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); }
        .option-header { display: flex; align-items: center; margin-bottom: 5px; }
        .option-desc { font-size: 0.85rem; color: #666; margin-left: 25px; line-height: 1.4; }
        .param-panel { background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 15px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .param-item { display: flex; align-items: center; gap: 8px; }
        .param-item label { font-weight: 500; min-width: 100px; }
        .param-item input { width: 100px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-small { background-color: #6c757d; color: white; border: none; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
        .btn-small:hover { background-color: #545b62; }
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.95rem; }
        th { background-color: #f0f0f0; padding: 12px 5px; border: 1px solid #ddd; font-weight: 600; }
        td { border: 1px solid #ddd; padding: 8px 5px; }
        td input { width: 100%; padding: 6px 4px; border: 1px solid #ccc; border-radius: 4px; }
        td input::placeholder { color: #aaa; font-style: italic; font-size: 0.9rem; }
        .btn-group { display: flex; gap: 10px; margin: 15px 0 5px; }
        button { background-color: #c41e3a; color: white; border: none; padding: 10px 20px; border-radius: 30px; font-size: 1rem; cursor: pointer; }
        button:hover { background-color: #a01830; }
        button.secondary { background-color: #6c757d; }
        .result-box { background: #e8f4fd; border-radius: 10px; padding: 20px; margin-top: 30px; border: 1px solid #b8daff; }
        .summary { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 20px; }
        .summary-item { background: white; padding: 12px 25px; border-radius: 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .summary-item span { font-weight: 700; color: #c41e3a; margin-left: 10px; font-size: 1.3rem; }
        .footer { text-align: center; color: #777; margin-top: 30px; }
        .info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 5px; padding: 8px; margin: 10px 0; }
        .hint { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ§§ æ˜¥èŠ‚å¹´è´§é‡‡è´­ä¼˜åŒ– Â· å¤šé€‰ç»„åˆç‰ˆ</h1>
    
    <!-- å…¨å±€è®¾ç½® -->
    <div class="settings-panel">
        <div class="settings-item">
            <label>æ€»é¢„ç®— (å…ƒ):</label>
            <input type="number" id="budget" value="8000" min="0" step="100">
        </div>
        <div class="settings-item">
            <label>å‰©ä½™é¢„ç®—:</label>
            <span id="budgetRemaining" style="font-weight:700; color:#28a745;">8000</span>
        </div>
    </div>

    <!-- æ¨¡å‹é€‰æ‹©åŒºåŸŸ -->
    <div class="model-section">
        <!-- ç›®æ ‡å‡½æ•°ï¼ˆå•é€‰ï¼‰ -->
        <div class="model-group">
            <div class="group-title">ğŸ¯ ç›®æ ‡å‡½æ•°ç±»å‹ï¼ˆä¸‰é€‰ä¸€ï¼‰</div>
            <div class="option-row">
                <div class="option-item">
                    <div class="option-header">
                        <input type="radio" name="objective" id="objBase" value="base" checked>
                        <label for="objBase"><strong>åŸºç¡€æ¨¡å‹</strong></label>
                    </div>
                    <div class="option-desc">æœ€å¤§åŒ–å®¶åº­æ€»æ»¡æ„åº¦ï¼ˆæ‰€æœ‰æˆå‘˜è¯„åˆ†ä¹‹å’Œï¼‰ï¼Œä¸è€ƒè™‘ä»£é™…å·®å¼‚ã€‚</div>
                </div>
                <div class="option-item">
                    <div class="option-header">
                        <input type="radio" name="objective" id="objMulti" value="multi">
                        <label for="objMulti"><strong>å¤šç›®æ ‡åŠ æƒ</strong></label>
                    </div>
                    <div class="option-desc">ä¸ºé€‰å®šçš„ä»£é™…è®¾ç½®æƒé‡ï¼Œæœ€å¤§åŒ–åŠ æƒæ»¡æ„åº¦ï¼Œå¹³è¡¡ä»£é™…åå¥½ã€‚</div>
                </div>
                <div class="option-item">
                    <div class="option-header">
                        <input type="radio" name="objective" id="objNonlinear" value="nonlinear">
                        <label for="objNonlinear"><strong>éçº¿æ€§æ•ˆç”¨</strong></label>
                    </div>
                    <div class="option-desc">ä½¿ç”¨å¯¹æ•°å‡½æ•° U = aÂ·ln(1+x) æ¨¡æ‹Ÿè¾¹é™…æ•ˆç”¨é€’å‡ï¼Œæ›´ç¬¦åˆå®é™…æ¶ˆè´¹å¿ƒç†ã€‚</div>
                </div>
            </div>
            
            <!-- å¤šç›®æ ‡æƒé‡é¢æ¿ï¼ˆåŒ…å«ä»£é™…é€‰æ‹©ï¼‰ -->
            <div id="multiPanel" class="param-panel" style="display: none; flex-direction: column; align-items: flex-start;">
                <div style="width:100%;">
                    <div class="group-title" style="margin-top:0;">ğŸ‘¥ å‚ä¸åŠ æƒçš„ä»£é™…</div>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="useG" value="G" checked> ç¥–è¾ˆ</label>
                        <label><input type="checkbox" id="useF" value="F" checked> çˆ¶è¾ˆ</label>
                        <label><input type="checkbox" id="useC" value="C" checked> å­è¾ˆ</label>
                    </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center; width:100%;">
                    <div class="param-item" id="wG_item"><label>ç¥–è¾ˆæƒé‡:</label><input type="number" id="wG" value="0.3" min="0" max="1" step="0.05"></div>
                    <div class="param-item" id="wF_item"><label>çˆ¶è¾ˆæƒé‡:</label><input type="number" id="wF" value="0.5" min="0" max="1" step="0.05"></div>
                    <div class="param-item" id="wC_item"><label>å­è¾ˆæƒé‡:</label><input type="number" id="wC" value="0.2" min="0" max="1" step="0.05"></div>
                    <button class="btn-small" id="ahpBtn">ğŸ“ AHPè®¡ç®—æƒé‡</button>
                    <span style="color:#666;">(ç‚¹å‡»åé€šè¿‡ä¸¤ä¸¤æ¯”è¾ƒè‡ªåŠ¨è®¡ç®—)</span>
                </div>
                <div style="font-size:0.9rem; color:#555; margin-top:5px;">æƒé‡å½’ä¸€åŒ–ä»…é’ˆå¯¹é€‰ä¸­çš„ä»£é™…ï¼Œæœªé€‰ä¸­ä»£é™…æƒé‡è§†ä¸º0ã€‚</div>
            </div>
        </div>

        <!-- é™„åŠ çº¦æŸï¼ˆå¯å¤šé€‰ï¼‰ -->
        <div class="model-group">
            <div class="group-title">ğŸ›¡ï¸ é™„åŠ çº¦æŸï¼ˆå¯å¤šé€‰ï¼‰</div>
            <div class="option-row">
                <div class="option-item">
                    <div class="option-header">
                        <input type="checkbox" id="robustCheck">
                        <label for="robustCheck"><strong>é²æ£’ä¼˜åŒ–</strong></label>
                    </div>
                    <div class="option-desc">è€ƒè™‘ä»·æ ¼æ³¢åŠ¨ï¼ˆå¦‚æ¶¨ä»·10%ï¼‰ï¼Œè®¾å®šä¿æŠ¤é¢„ç®— Î“ï¼Œç¡®ä¿åœ¨æœ€åæƒ…å†µä¸‹ä¸è¶…é¢„ç®—ã€‚</div>
                </div>
            </div>
            <!-- é²æ£’å‚æ•°é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
            <div id="robustPanel" class="param-panel" style="display: none; margin-top:15px;">
                <div class="param-item"><label>ä»·æ ¼æ³¢åŠ¨å¹…åº¦ (%):</label><input type="number" id="epsilon" value="10" min="0" max="100" step="1"></div>
                <div class="param-item"><label>ä¿æŠ¤é¢„ç®— Î“ (æœ€å¤šæ¶¨ä»·å•†å“æ•°):</label><input type="number" id="gamma" value="3" min="1" step="1"></div>
            </div>
        </div>
    </div>

    <!-- å•†å“è¡¨æ ¼ -->
    <h2>ğŸ“¦ å•†å“ä¿¡æ¯</h2>
    <div class="hint">ä¸‹æ–¹è¡¨æ ¼ä¸­ï¼Œå°†é¼ æ ‡æ‚¬åœåœ¨è¾“å…¥æ¡†ä¸Šå¯æŸ¥çœ‹ç¤ºä¾‹æ ¼å¼ï¼Œç›´æ¥è¾“å…¥æ‚¨çš„æ•°æ®å³å¯ã€‚å¯é€šè¿‡ä¸‹æ–¹æŒ‰é’®æ·»åŠ æˆ–åˆ é™¤è¡Œã€‚</div>
    <table id="goodsTable">
        <thead id="tableHeader"></thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="btn-group">
        <button id="addRowBtn">â• æ·»åŠ ä¸€è¡Œ</button>
        <button id="removeRowBtn">â– åˆ é™¤æœ€åä¸€è¡Œ</button>
        <button id="calcBtn" style="margin-left:auto;">ğŸš€ å¼€å§‹ä¼˜åŒ–</button>
    </div>

    <!-- ç»“æœ -->
    <div id="resultArea" class="result-box" style="display: none;"></div>
    <div class="footer">åŸºäºè®ºæ–‡ã€Šæ˜¥èŠ‚å¹´è´§é‡‡è´­çš„å¤šç›®æ ‡ä¼˜åŒ–é…ç½®æ¨¡å‹ã€‹æ‰©å±•ç‰ˆ</div>
</div>

<script>
    // å½“å‰é€‰ä¸­çš„ç›®æ ‡å‡½æ•°
    let objective = 'base';
    // æ˜¯å¦å¯ç”¨é²æ£’
    let robustEnabled = false;

    // åˆ—å®šä¹‰
    const baseCols = ['å•†å“åç§°', 'å•ä»·(å…ƒ)', 'ä¸æµªè´¹ä¸Šé™', 'åˆšæ€§éœ€æ±‚æ•°é‡', 'å®¶åº­æ€»è¯„åˆ†'];
    const multiCols = ['å•†å“åç§°', 'å•ä»·(å…ƒ)', 'ä¸æµªè´¹ä¸Šé™', 'åˆšæ€§éœ€æ±‚æ•°é‡', 'ç¥–è¾ˆè¯„åˆ†å’Œ', 'çˆ¶è¾ˆè¯„åˆ†å’Œ', 'å­è¾ˆè¯„åˆ†å’Œ'];
    const nonlinearCols = baseCols;

    // è·å–å½“å‰åº”æ˜¾ç¤ºçš„åˆ—
    function getCurrentCols() {
        if (objective === 'multi') return multiCols;
        return baseCols;
    }

    // è·å–placeholderæ–‡æœ¬
    function getPlaceholder(col) {
        const map = {
            'å•†å“åç§°': 'ä¾‹å¦‚ æ–°è¡£',
            'å•ä»·(å…ƒ)': 'ä¾‹å¦‚ 100',
            'ä¸æµªè´¹ä¸Šé™': 'ä¾‹å¦‚ 6',
            'åˆšæ€§éœ€æ±‚æ•°é‡': 'ä¾‹å¦‚ 0 (éåˆšæ€§)',
            'å®¶åº­æ€»è¯„åˆ†': 'ä¾‹å¦‚ 150',
            'ç¥–è¾ˆè¯„åˆ†å’Œ': 'ä¾‹å¦‚ 9',
            'çˆ¶è¾ˆè¯„åˆ†å’Œ': 'ä¾‹å¦‚ 7',
            'å­è¾ˆè¯„åˆ†å’Œ': 'ä¾‹å¦‚ 10'
        };
        return map[col] || 'è¯·è¾“å…¥';
    }

    // æ¸²æŸ“è¡¨æ ¼ï¼ˆæ— é»˜è®¤å€¼ï¼Œä»…placeholderï¼‰
    function renderTable() {
        const header = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        const cols = getCurrentCols();
        
        let headerHtml = '<tr>';
        cols.forEach(col => headerHtml += `<th>${col}</th>`);
        headerHtml += '</tr>';
        header.innerHTML = headerHtml;
        
        // ä¿ç•™ç°æœ‰è¡Œæ•°ï¼Œé»˜è®¤ä¸º3è¡Œç©ºè¡Œ
        const rows = body.children.length || 3;
        let bodyHtml = '';
        for (let i = 0; i < rows; i++) {
            bodyHtml += '<tr>';
            cols.forEach(col => {
                let placeholder = getPlaceholder(col);
                bodyHtml += `<td><input type="text" placeholder="${placeholder}"></td>`;
            });
            bodyHtml += '</tr>';
        }
        body.innerHTML = bodyHtml;
    }

    // æ›´æ–°é¢æ¿æ˜¾ç¤º
    function updatePanels() {
        document.getElementById('multiPanel').style.display = (objective === 'multi') ? 'flex' : 'none';
        document.getElementById('robustPanel').style.display = robustEnabled ? 'flex' : 'none';
        updateWeightVisibility();
        renderTable();
    }

    function updateWeightVisibility() {
        const useG = document.getElementById('useG').checked;
        const useF = document.getElementById('useF').checked;
        const useC = document.getElementById('useC').checked;
        document.getElementById('wG_item').style.display = useG ? 'flex' : 'none';
        document.getElementById('wF_item').style.display = useF ? 'flex' : 'none';
        document.getElementById('wC_item').style.display = useC ? 'flex' : 'none';
    }

    // ç›‘å¬ç›®æ ‡å‡½æ•°å•é€‰
    document.querySelectorAll('input[name="objective"]').forEach(radio => {
        radio.addEventListener('change', function() {
            objective = this.value;
            updatePanels();
        });
    });

    document.getElementById('useG').addEventListener('change', updateWeightVisibility);
    document.getElementById('useF').addEventListener('change', updateWeightVisibility);
    document.getElementById('useC').addEventListener('change', updateWeightVisibility);

    document.getElementById('robustCheck').addEventListener('change', function() {
        robustEnabled = this.checked;
        updatePanels();
    });

    // AHPæƒé‡è®¡ç®—ï¼ˆç®€æ˜“ç‰ˆï¼Œåªå¯¹é€‰ä¸­çš„ä»£é™…è¿›è¡Œï¼‰
    document.getElementById('ahpBtn').addEventListener('click', function() {
        const useG = document.getElementById('useG').checked;
        const useF = document.getElementById('useF').checked;
        const useC = document.getElementById('useC').checked;
        const selected = [];
        if (useG) selected.push('G');
        if (useF) selected.push('F');
        if (useC) selected.push('C');
        if (selected.length < 2) {
            alert('è‡³å°‘éœ€è¦é€‰ä¸­ä¸¤ä¸ªä»£é™…æ‰èƒ½è¿›è¡ŒAHPæ¯”è¾ƒã€‚');
            return;
        }

        let values = {};
        if (selected.includes('G') && selected.includes('F')) {
            let val = prompt('è¯·æ¯”è¾ƒç¥–è¾ˆ vs çˆ¶è¾ˆçš„é‡è¦æ€§ï¼ˆè¾“å…¥æ•°å­—ï¼š1=åŒç­‰é‡è¦ï¼Œ3=ç¥–è¾ˆç¨é‡è¦ï¼Œ1/3=çˆ¶è¾ˆç¨é‡è¦ï¼‰ï¼š', '0.5');
            values['GF'] = parseFloat(val) || 1;
        }
        if (selected.includes('G') && selected.includes('C')) {
            let val = prompt('è¯·æ¯”è¾ƒç¥–è¾ˆ vs å­è¾ˆçš„é‡è¦æ€§ï¼š', '2');
            values['GC'] = parseFloat(val) || 1;
        }
        if (selected.includes('F') && selected.includes('C')) {
            let val = prompt('è¯·æ¯”è¾ƒçˆ¶è¾ˆ vs å­è¾ˆçš„é‡è¦æ€§ï¼š', '3');
            values['FC'] = parseFloat(val) || 1;
        }

        let order = selected;
        let matrix = [];
        for (let i = 0; i < order.length; i++) {
            matrix[i] = [];
            for (let j = 0; j < order.length; j++) {
                if (i === j) matrix[i][j] = 1;
                else {
                    let key = order[i] + order[j];
                    let revKey = order[j] + order[i];
                    if (values[key]) matrix[i][j] = values[key];
                    else if (values[revKey]) matrix[i][j] = 1 / values[revKey];
                    else matrix[i][j] = 1;
                }
            }
        }

        let weights = [];
        for (let i = 0; i < order.length; i++) {
            let product = 1;
            for (let j = 0; j < order.length; j++) product *= matrix[i][j];
            weights.push(Math.pow(product, 1/order.length));
        }
        let sum = weights.reduce((a,b) => a+b, 0);
        weights = weights.map(w => w/sum);

        for (let idx = 0; idx < order.length; idx++) {
            if (order[idx] === 'G') document.getElementById('wG').value = weights[idx].toFixed(3);
            else if (order[idx] === 'F') document.getElementById('wF').value = weights[idx].toFixed(3);
            else if (order[idx] === 'C') document.getElementById('wC').value = weights[idx].toFixed(3);
        }

        alert('AHPè®¡ç®—å®Œæˆï¼Œæƒé‡å·²è‡ªåŠ¨å¡«å…¥ã€‚');
    });

    // æ·»åŠ è¡Œ
    document.getElementById('addRowBtn').addEventListener('click', function() {
        const body = document.getElementById('tableBody');
        const cols = getCurrentCols();
        let rowHtml = '<tr>';
        cols.forEach(col => {
            let placeholder = getPlaceholder(col);
            rowHtml += `<td><input type="text" placeholder="${placeholder}"></td>`;
        });
        rowHtml += '</tr>';
        body.insertAdjacentHTML('beforeend', rowHtml);
    });

    // åˆ é™¤è¡Œ
    document.getElementById('removeRowBtn').addEventListener('click', function() {
        const body = document.getElementById('tableBody');
        if (body.children.length > 1) body.removeChild(body.lastChild);
    });

    // ========== ä¼˜åŒ–è®¡ç®— ==========
    document.getElementById('calcBtn').addEventListener('click', function() {
        const budget = parseFloat(document.getElementById('budget').value);
        const rows = document.getElementById('tableBody').children;
        const cols = getCurrentCols();
        
        let names = [], prices = [], ub = [], mandatory = [], scores = [];
        let G = [], F = [], C = [];
        
        for (let row of rows) {
            const inputs = row.querySelectorAll('input');
            let rowData = {};
            inputs.forEach((input, idx) => {
                rowData[cols[idx]] = input.value.trim();
            });
            
            const name = rowData['å•†å“åç§°'];
            if (!name) continue;  // è·³è¿‡ç©ºè¡Œ
            
            names.push(name);
            prices.push(parseFloat(rowData['å•ä»·(å…ƒ)']) || 0);
            ub.push(parseInt(rowData['ä¸æµªè´¹ä¸Šé™']) || 0);
            mandatory.push(parseInt(rowData['åˆšæ€§éœ€æ±‚æ•°é‡']) || 0);
            
            if (objective === 'multi') {
                let g = parseFloat(rowData['ç¥–è¾ˆè¯„åˆ†å’Œ']) || 0;
                let f = parseFloat(rowData['çˆ¶è¾ˆè¯„åˆ†å’Œ']) || 0;
                let c = parseFloat(rowData['å­è¾ˆè¯„åˆ†å’Œ']) || 0;
                G.push(g); F.push(f); C.push(c);
                scores.push(g + f + c);
            } else {
                scores.push(parseFloat(rowData['å®¶åº­æ€»è¯„åˆ†']) || 0);
            }
        }
        
        if (names.length === 0) {
            alert('è¯·è‡³å°‘å¡«å†™ä¸€ç§å•†å“ï¼');
            return;
        }

        let remaining = budget;
        let buy = new Array(names.length).fill(0);
        
        // åˆšæ€§éœ€æ±‚
        for (let i = 0; i < names.length; i++) {
            if (mandatory[i] > 0) {
                let qty = Math.min(mandatory[i], ub[i]);
                let cost = prices[i] * qty;
                if (cost <= remaining) {
                    buy[i] = qty;
                    remaining -= cost;
                } else {
                    alert(`é¢„ç®—ä¸è¶³ä»¥è´­ä¹°åˆšæ€§éœ€æ±‚çš„ ${names[i]}`);
                    return;
                }
            }
        }
        
        if (objective === 'nonlinear') {
            nonlinearGreedy();
        } else {
            normalGreedy();
        }
        
        function normalGreedy() {
            let items = [];
            for (let i = 0; i < names.length; i++) {
                if (buy[i] < ub[i] && prices[i] > 0) {
                    let ratio = scores[i] / prices[i];
                    items.push({idx: i, ratio: ratio});
                }
            }
            items.sort((a, b) => b.ratio - a.ratio);
            
            for (let item of items) {
                let i = item.idx;
                let maxQty = ub[i] - buy[i];
                let possibleQty = Math.floor(remaining / prices[i]);
                let qty = Math.min(maxQty, possibleQty);
                if (qty > 0) {
                    buy[i] += qty;
                    remaining -= prices[i] * qty;
                }
            }
            if (robustEnabled) {
                robustAdjust();
            } else {
                showResults();
            }
        }
        
        function nonlinearGreedy() {
            let items = [];
            for (let i = 0; i < names.length; i++) {
                if (buy[i] < ub[i] && prices[i] > 0) {
                    let a = scores[i] / Math.log(2);
                    let current = buy[i];
                    let marginal = a * (Math.log(2 + current) - Math.log(1 + current));
                    let ratio = marginal / prices[i];
                    items.push({idx: i, ratio: ratio});
                }
            }
            items.sort((a, b) => b.ratio - a.ratio);
            
            for (let item of items) {
                let i = item.idx;
                let maxQty = ub[i] - buy[i];
                let possibleQty = Math.floor(remaining / prices[i]);
                let qty = Math.min(maxQty, possibleQty);
                if (qty > 0) {
                    buy[i] += qty;
                    remaining -= prices[i] * qty;
                }
            }
            if (robustEnabled) {
                robustAdjust();
            } else {
                showResults();
            }
        }
        
        function robustAdjust() {
            let tempBuy = [...buy];
            let tempRemaining = remaining;
            let epsilon = parseFloat(document.getElementById('epsilon').value) / 100;
            let gamma = parseInt(document.getElementById('gamma').value);
            
            let costInc = [];
            for (let i = 0; i < names.length; i++) {
                if (tempBuy[i] > 0) {
                    costInc.push({idx: i, extra: prices[i] * tempBuy[i] * epsilon});
                }
            }
            costInc.sort((a, b) => b.extra - a.extra);
            let totalExtra = 0;
            for (let i = 0; i < Math.min(gamma, costInc.length); i++) {
                totalExtra += costInc[i].extra;
            }
            let worstTotal = budget - tempRemaining + totalExtra;
            
            if (worstTotal > budget) {
                alert(`é²æ£’ä¼˜åŒ–ï¼šæœ€åæƒ…å†µä¸‹å¯èƒ½è¶…æ”¯ ${(worstTotal - budget).toFixed(2)} å…ƒï¼Œå°†è‡ªåŠ¨è°ƒæ•´ã€‚`);
                while (worstTotal > budget) {
                    let maxIdx = -1, maxVal = -1;
                    for (let i = 0; i < names.length; i++) {
                        if (tempBuy[i] > 0 && prices[i] * tempBuy[i] > maxVal) {
                            maxVal = prices[i] * tempBuy[i];
                            maxIdx = i;
                        }
                    }
                    if (maxIdx === -1) break;
                    tempBuy[maxIdx]--;
                    tempRemaining += prices[maxIdx];
                    
                    costInc = [];
                    for (let i = 0; i < names.length; i++) {
                        if (tempBuy[i] > 0) {
                            costInc.push({idx: i, extra: prices[i] * tempBuy[i] * epsilon});
                        }
                    }
                    costInc.sort((a, b) => b.extra - a.extra);
                    totalExtra = 0;
                    for (let i = 0; i < Math.min(gamma, costInc.length); i++) {
                        totalExtra += costInc[i].extra;
                    }
                    worstTotal = budget - tempRemaining + totalExtra;
                }
                buy = tempBuy;
                remaining = tempRemaining;
            }
            showResults();
        }
        
        function showResults() {
            let totalCost = budget - remaining;
            let totalSat = 0;
            for (let i = 0; i < names.length; i++) {
                totalSat += scores[i] * buy[i];
            }
            
            let resultHtml = '<h2 style="margin-top:0;">âœ… æœ€ä¼˜é‡‡è´­æ–¹æ¡ˆ</h2>';
            resultHtml += '<div class="summary">';
            resultHtml += `<div class="summary-item">æ€»èŠ±è´¹ <span>${totalCost.toFixed(2)}</span> å…ƒ</div>`;
            resultHtml += `<div class="summary-item">å‰©ä½™é¢„ç®— <span>${remaining.toFixed(2)}</span> å…ƒ</div>`;
            resultHtml += `<div class="summary-item">æ€»æ»¡æ„åº¦ <span>${totalSat.toFixed(2)}</span> åˆ†</div>`;
            
            if (objective === 'multi') {
                const useG = document.getElementById('useG').checked;
                const useF = document.getElementById('useF').checked;
                const useC = document.getElementById('useC').checked;
                let wG = useG ? parseFloat(document.getElementById('wG').value) : 0;
                let wF = useF ? parseFloat(document.getElementById('wF').value) : 0;
                let wC = useC ? parseFloat(document.getElementById('wC').value) : 0;
                let totalW = wG + wF + wC;
                if (totalW > 0) {
                    wG /= totalW; wF /= totalW; wC /= totalW;
                }
                
                let totalG = 0, totalF = 0, totalC = 0;
                for (let i = 0; i < names.length; i++) {
                    totalG += G[i] * buy[i];
                    totalF += F[i] * buy[i];
                    totalC += C[i] * buy[i];
                }
                let weighted = (useG ? wG*totalG : 0) + (useF ? wF*totalF : 0) + (useC ? wC*totalC : 0);
                resultHtml += `<div class="summary-item">åŠ æƒå’Œ <span>${weighted.toFixed(2)}</span></div>`;
                resultHtml += '</div>';
                let detail = '';
                if (useG) detail += `ç¥–è¾ˆæ»¡æ„åº¦: ${totalG.toFixed(2)} `;
                if (useF) detail += `çˆ¶è¾ˆæ»¡æ„åº¦: ${totalF.toFixed(2)} `;
                if (useC) detail += `å­è¾ˆæ»¡æ„åº¦: ${totalC.toFixed(2)} `;
                resultHtml += `<p>${detail}</p>`;
            } else {
                resultHtml += '</div>';
            }
            
            if (robustEnabled) {
                let epsilon = document.getElementById('epsilon').value;
                let gamma = document.getElementById('gamma').value;
                resultHtml += `<p class="info">å·²å¯ç”¨é²æ£’ä¼˜åŒ–ï¼šæ³¢åŠ¨ ${epsilon}%ï¼Œä¿æŠ¤é¢„ç®— Î“=${gamma}ï¼Œæ–¹æ¡ˆå·²è€ƒè™‘æœ€åæƒ…å†µã€‚</p>`;
            }
            if (objective === 'nonlinear') {
                resultHtml += `<p class="info">å·²å¯ç”¨éçº¿æ€§æ•ˆç”¨ï¼šä½¿ç”¨å¯¹æ•°å‡½æ•° U = aÂ·ln(1+x) è®¡ç®—è¾¹é™…æ€§ä»·æ¯”ã€‚</p>`;
            }
            
            resultHtml += '<h3>ğŸ›’ é‡‡è´­æ¸…å•</h3><table><tr><th>å•†å“</th><th>æ•°é‡</th><th>èŠ±è´¹</th><th>æ»¡æ„åº¦è´¡çŒ®</th></tr>';
            for (let i = 0; i < names.length; i++) {
                if (buy[i] > 0) {
                    resultHtml += `<tr><td>${names[i]}</td><td>${buy[i]}</td><td>${(prices[i]*buy[i]).toFixed(2)}</td><td>${(scores[i]*buy[i]).toFixed(2)}</td></tr>`;
                }
            }
            resultHtml += '</table>';
            
            document.getElementById('resultArea').innerHTML = resultHtml;
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('budgetRemaining').innerText = remaining.toFixed(2);
        }
    });

    // åˆå§‹åŒ–
    updatePanels();
</script>
</body>
</html>